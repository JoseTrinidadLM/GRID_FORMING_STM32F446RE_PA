###############################################################################
# Project Name
###############################################################################
PROJECT = GRID_FORMING

###############################################################################
# Paths
###############################################################################
ROOT_DIR := .
SRC_DIR := $(ROOT_DIR)/Src
DRV_DIR := $(ROOT_DIR)/drivers

BUILD_DIR := build

###############################################################################
# Toolchain
###############################################################################
CC = arm-none-eabi-gcc
AS = arm-none-eabi-gcc
LD = arm-none-eabi-gcc
OBJCOPY = arm-none-eabi-objcopy
SIZE = arm-none-eabi-size

###############################################################################
# MCU CONFIG
###############################################################################
CPU = -mcpu=cortex-m4
FPU = -mfpu=fpv4-sp-d16
FLOAT_ABI = -mfloat-abi=hard
THUMB = -mthumb

MCUFLAGS = $(CPU) $(FPU) $(FLOAT_ABI) $(THUMB)

###############################################################################
# Linker Script
###############################################################################
LDSCRIPT = STM32F446RETX_FLASH.ld

###############################################################################
# Sources
###############################################################################
C_SOURCES = \
    $(wildcard $(SRC_DIR)/*.c) \
    $(wildcard $(DRV_DIR)/Src/*.c)

ASM_SOURCES = \
    $(ROOT_DIR)/Startup/startup_stm32f446retx.s

###############################################################################
# Include Paths
###############################################################################
INCLUDES = \
    -I$(SRC_DIR) \
    -I$(DRV_DIR)/Inc

###############################################################################
# CFLAGS
###############################################################################
CFLAGS = $(MCUFLAGS) -O2 -g3 -Wall -ffunction-sections -fdata-sections
CFLAGS += $(INCLUDES)

###############################################################################
# LDFLAGS
###############################################################################
LDFLAGS = $(MCUFLAGS) -Wl,--gc-sections -Wl,-Map=$(BUILD_DIR)/$(PROJECT).map
LDFLAGS += -T$(LDSCRIPT)

###############################################################################
# Object Files
###############################################################################
OBJ = $(addprefix $(BUILD_DIR)/,$(notdir $(C_SOURCES:.c=.o)))
OBJ += $(BUILD_DIR)/startup_stm32f446retx.o

###############################################################################
# Rules
###############################################################################
all: $(BUILD_DIR)/$(PROJECT).elf

$(BUILD_DIR):
	mkdir -p $(BUILD_DIR)

# Build C files
$(BUILD_DIR)/%.o: $(SRC_DIR)/%.c | $(BUILD_DIR)
	$(CC) $(CFLAGS) -c $< -o $@

$(BUILD_DIR)/%.o: $(DRV_DIR)/Src/%.c | $(BUILD_DIR)
	$(CC) $(CFLAGS) -c $< -o $@

# Build ASM file
$(BUILD_DIR)/startup_stm32f446retx.o: $(ROOT_DIR)/Startup/startup_stm32f446retx.s | $(BUILD_DIR)
	$(AS) $(MCUFLAGS) -c $< -o $@

# Link
$(BUILD_DIR)/$(PROJECT).elf: $(OBJ)
	$(LD) $(OBJ) $(LDFLAGS) -o $@
	$(SIZE) $@

###############################################################################
# Additional outputs
###############################################################################
bin:
	$(OBJCOPY) -O binary $(BUILD_DIR)/$(PROJECT).elf $(BUILD_DIR)/$(PROJECT).bin

hex:
	$(OBJCOPY) -O ihex $(BUILD_DIR)/$(PROJECT).elf $(BUILD_DIR)/$(PROJECT).hex

###############################################################################
# Clean
###############################################################################
clean:
	rm -rf $(BUILD_DIR)

###############################################################################
# End of Makefile
###############################################################################
